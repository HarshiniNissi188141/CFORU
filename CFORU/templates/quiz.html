<!DOCTYPE html>
<html>
<head>
    <title>Secure Exam Console</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <style>
        /* Code Block */
        pre { background: #1a1a2e; padding: 20px; border-radius: 8px; border-left: 4px solid #00ffff; overflow-x: auto; margin-bottom: 20px; }
        code { font-family: 'Courier New', monospace; font-size: 16px; text-shadow: none; }

        /* Feedback Overlay (Only for Practice/Mock) */
        #feedback-overlay { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #0a0a12; border-top: 3px solid #333; padding: 30px 20px; z-index: 2000; text-align: center; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { bottom: -100%; } to { bottom: 0; } }
        
        .fb-header { font-size: 28px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        .fb-text { font-size: 18px; color: #ccc; margin-bottom: 20px; font-family: monospace; max-width: 800px; margin-left: auto; margin-right: auto; }
        
        .correct-mode { border-color: #00ff00 !important; }
        .correct-mode .fb-header { color: #00ff00; }
        .wrong-mode { border-color: #ff3333 !important; }
        .wrong-mode .fb-header { color: #ff3333; }
        
        /* Selection Styles */
        .selected-opt { border-color: #00ffff !important; background: rgba(0, 255, 255, 0.1) !important; color: white !important; }
        .disabled-opt { pointer-events: none; opacity: 0.5; }
    </style>
</head>
<body>

    <div class="container">
        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #00ffff; padding-bottom:10px; margin-bottom: 20px;">
            <h2 id="exam-title" style="margin:0; color: #00ffff;">LOADING...</h2>
            <div style="color:#ff00ff; font-weight:bold; font-size: 20px;">Time: <span id="timer">00:00</span></div>
        </div>
        
        <div id="quiz-box">
            <h3 id="q-text" style="color: #fff; margin-bottom: 15px;">Question Loading...</h3>
            <pre><code id="q-code" class="language-c"></code></pre>
            <div id="options" class="module-grid"></div>
            <button id="silent-next-btn" onclick="nextQuestion()" class="btn-main" style="display:none; margin-top:20px;">Submit Answer & Next &rarr;</button>
        </div>
        
        <form id="submitForm" action="/submit_quiz" method="POST" style="display:none; text-align:center;">
            <input type="hidden" name="score" id="finalScore">
            <input type="hidden" name="test_type" value="{{ test_type }}">
            <h1 style="color:#00ff00; font-size: 40px;">Exam Submitted!</h1>
            <p>Calculating your Certification Status...</p>
            <button type="submit" class="btn-main">View Results</button>
        </form>
    </div>

    <div id="feedback-overlay">
        <div id="fb-icon" style="font-size: 40px; margin-bottom: 10px;"></div>
        <div id="fb-header" class="fb-header"></div>
        <div id="fb-text" class="fb-text"></div>
        <button onclick="nextQuestion()" class="btn-main" style="width:auto; padding: 10px 50px; border-color: white; color: white;">Next Question &rarr;</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>

    <script>
        const type = "{{ test_type }}";
        let qList = [], curr = 0, score = 0, time = 0;
        let warningCount = 0;

        // --- 1. SECURITY SYSTEM (ANTI-CHEAT) ---
        if(type === 'final') {
            document.addEventListener("visibilitychange", function() {
                if (document.hidden) {
                    warningCount++;
                    if(warningCount === 1) {
                        alert("‚ö†Ô∏è WARNING: Tab switching is forbidden! Next time your exam will auto-submit.");
                    } else {
                        alert("üö´ SECURITY VIOLATION. Submitting Exam Now.");
                        document.getElementById('quiz-box').style.display='none';
                        document.getElementById('submitForm').style.display='block';
                        document.getElementById('finalScore').value = score;
                        document.getElementById('submitForm').submit();
                    }
                }
            });
        }

        // --- 2. ADVANCED GENERATOR ---
        function getRandomInt(max) { return Math.floor(Math.random() * max); }

        function generateInfiniteQ() {
            // Mix of Advanced Concepts (Pointers, Structs, Files, Preprocessor)
            let rng = Math.random();
            
            if (rng < 0.2) { // Structs
                return { q: "What is the output?", code: `#include <stdio.h>\nstruct Point { int x, y; };\nint main() {\n  struct Point p = {10, 20};\n  struct Point *ptr = &p;\n  printf("%d", ptr->x);\n  return 0;\n}`, o: ["10", "20", "Error", "Garbage"], a: 0, r: "Arrow operator (->) accesses struct members via pointer." };
            } else if (rng < 0.4) { // Macros
                let val = getRandomInt(5) + 2;
                return { q: "Analyze Macro Expansion:", code: `#define MUL(a, b) a*b\nint main() {\n  printf("%d", MUL(${val}+1, 5));\n  return 0;\n}`, o: [`${(val+1)*5}`, `${val + 5}`, "Error", "0"], a: 1, r: `Macros do simple text replacement. ${val}+1 * 5 becomes ${val} + 5 = ${val+5}. Use parenthesis in macros to fix this!` };
            } else if (rng < 0.6) { // Pointer Arithmetic
                let start = getRandomInt(100);
                return { q: "Pointer Logic:", code: `#include <stdio.h>\nint main() {\n  int arr[] = {${start}, ${start+1}, ${start+2}};\n  int *p = arr;\n  p++;\n  printf("%d", *p);\n  return 0;\n}`, o: [`${start}`, `${start+1}`, `${start+2}`, "Address"], a: 1, r: "p++ moves the pointer to the next integer index." };
            } else if (rng < 0.8) { // File Handling
                return { q: "Which mode opens a file for reading?", code: `FILE *fp = fopen("data.txt", "___");`, o: ["w", "r", "a", "w+"], a: 1, r: "'r' opens a file for reading. 'w' overwrites." };
            } else { // Static
                return { q: "Output of Static Variable:", code: `void f() { static int i=0; i++; printf("%d", i); }\nint main() { f(); f(); }`, o: ["1 1", "1 2", "0 1", "Error"], a: 1, r: "Static variables persist between calls." };
            }
        }

        function genQ(count, topic) {
            let arr = [];
            for(let i=1; i<=count; i++) {
                let qObj = generateInfiniteQ();
                if(type === 'final') {
                    // Hide "Type" in Final Exam
                    qObj.q = `Question ${i}: Analyze the code below.`;
                }
                arr.push(qObj);
            }
            return arr;
        }

        // --- 3. EXAM CONFIG ---
        if(type==='final') { 
            document.getElementById('exam-title').innerText="üèÜ FINAL ASSESSMENT (SECURE MODE)"; 
            qList=genQ(40,"Final"); // 40 QUESTIONS
            time=45*60; 
        } else if(type==='practice') {
             document.getElementById('exam-title').innerText="‚ôæÔ∏è INFINITE PRACTICE"; qList=genQ(10,"Random"); time=9999; 
        } else { 
            document.getElementById('exam-title').innerText=`üìù MOCK TEST (${type})`; qList=genQ(20,"Mock"); time=15*60; 
        }

        // --- 4. DISPLAY ---
        function load() {
            if(curr >= qList.length) {
                document.getElementById('quiz-box').style.display='none';
                document.getElementById('feedback-overlay').style.display='none';
                document.getElementById('submitForm').style.display='block';
                document.getElementById('finalScore').value=score;
                return;
            }
            let q = qList[curr];
            document.getElementById('q-text').innerText = q.q;
            const codeEl = document.getElementById('q-code');
            codeEl.textContent = q.code;
            Prism.highlightElement(codeEl);

            let h = "";
            q.o.forEach((o,i) => h += `<button id="opt_${i}" class="card option-btn" onclick="check(${i})">${o}</button>`);
            document.getElementById('options').innerHTML = h;
            
            // Hide Next Button initially
            document.getElementById('silent-next-btn').style.display = 'none';
        }

        // --- 5. CHECK LOGIC (SILENT FOR FINAL) ---
        function check(ans) {
            const q = qList[curr];
            
            // Highlight Selected
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected-opt'));
            document.getElementById(`opt_${ans}`).classList.add('selected-opt');

            // IF FINAL EXAM: SILENT MODE
            if(type === 'final') {
                if(ans === q.a) score++; // Record score silently
                document.getElementById('silent-next-btn').style.display = 'block'; // Show Next button
            } 
            // IF PRACTICE/MOCK: SHOW FEEDBACK
            else {
                const overlay = document.getElementById('feedback-overlay');
                document.querySelectorAll('.option-btn').forEach(b => b.classList.add('disabled-opt'));
                overlay.style.display = "block";
                
                if(ans === q.a) {
                    score++;
                    overlay.className = "correct-mode";
                    document.getElementById('fb-header').innerText = "YES! YOU ARE RIGHT";
                    document.getElementById('fb-text').innerText = q.reason;
                } else {
                    overlay.className = "wrong-mode";
                    document.getElementById('fb-header').innerText = "OH! DON'T WORRY";
                    document.getElementById('fb-text').innerText = q.reason;
                }
            }
        }

        function nextQuestion() {
            document.getElementById('feedback-overlay').style.display = "none";
            curr++;
            load();
        }

        setInterval(()=>{ 
            let m=Math.floor(time/60), s=time%60; 
            document.getElementById('timer').innerText=`${m}:${s<10?'0'+s:s}`; 
            if(time<=0) { 
                document.getElementById('quiz-box').style.display='none'; 
                document.getElementById('submitForm').style.display='block'; 
                document.getElementById('finalScore').value=score; 
            } 
            time--; 
        }, 1000);
        load();
    </script>
</body>
</html>